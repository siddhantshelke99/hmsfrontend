<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Create Stock Adjustment</h2>
      <p class="text-muted mb-0">Adjust stock for damaged, expired, or lost medicines</p>
    </div>
    <button class="btn btn-outline-secondary" (click)="cancel()">
      <i class="bi bi-arrow-left"></i> Back
    </button>
  </div>

  <!-- Loader -->
  <app-loader *ngIf="isSubmitting"></app-loader>

  <!-- Form -->
  <div class="row justify-content-center" *ngIf="!isSubmitting">
    <div class="col-lg-10">
      <form [formGroup]="adjustmentForm" (ngSubmit)="onSubmit()">
        
        <!-- Medicine Selection -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Medicine Selection</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">Search Medicine <span class="text-danger">*</span></label>
                <app-medicine-search></app-medicine-search>
                <input type="hidden" formControlName="medicineId">
                <input type="hidden" formControlName="medicineName">
                <div *ngIf="isFieldInvalid('medicineId')" class="text-danger small mt-1">
                  Please select a medicine
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Batch Number <span class="text-danger">*</span></label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="batchNumber"
                  [class.is-invalid]="isFieldInvalid('batchNumber')"
                  readonly>
                <div *ngIf="isFieldInvalid('batchNumber')" class="invalid-feedback">
                  Batch number is required
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Current Stock</label>
                <input 
                  type="number" 
                  class="form-control bg-light" 
                  formControlName="currentStock"
                  readonly>
              </div>
            </div>
          </div>
        </div>

        <!-- Adjustment Details -->
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Adjustment Details</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Adjustment Type <span class="text-danger">*</span></label>
                <select 
                  class="form-select" 
                  formControlName="adjustmentType"
                  [class.is-invalid]="isFieldInvalid('adjustmentType')">
                  <option value="">-- Select Type --</option>
                  <option 
                    *ngFor="let type of adjustmentTypes" 
                    [value]="type"
                    [ngClass]="getAdjustmentTypeClass(type)">
                    {{ getAdjustmentTypeLabel(type) }}
                  </option>
                </select>
                <div *ngIf="isFieldInvalid('adjustmentType')" class="invalid-feedback">
                  Please select adjustment type
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Quantity to Adjust <span class="text-danger">*</span></label>
                <input 
                  type="number" 
                  class="form-control" 
                  formControlName="quantity"
                  [class.is-invalid]="isFieldInvalid('quantity')"
                  placeholder="Enter quantity"
                  min="1">
                <div *ngIf="isFieldInvalid('quantity')" class="invalid-feedback">
                  Valid quantity is required (minimum 1)
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label">Reason for Adjustment <span class="text-danger">*</span></label>
                <textarea 
                  class="form-control" 
                  formControlName="reason"
                  [class.is-invalid]="isFieldInvalid('reason')"
                  rows="3"
                  placeholder="Provide detailed reason for adjustment (minimum 10 characters)"></textarea>
                <div *ngIf="isFieldInvalid('reason')" class="invalid-feedback">
                  Reason is required (minimum 10 characters)
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label">Additional Remarks</label>
                <textarea 
                  class="form-control" 
                  formControlName="remarks"
                  rows="2"
                  placeholder="Optional additional comments"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Stock Summary -->
        <div class="card mb-4 border-warning" *ngIf="adjustmentForm.get('quantity')?.value">
          <div class="card-body">
            <h6 class="mb-3">Stock Summary</h6>
            <div class="row">
              <div class="col-md-4">
                <div class="summary-item">
                  <label class="text-muted small">Current Stock</label>
                  <h4 class="mb-0">{{ adjustmentForm.get('currentStock')?.value }}</h4>
                </div>
              </div>
              <div class="col-md-4">
                <div class="summary-item">
                  <label class="text-muted small">Adjustment Quantity</label>
                  <h4 class="mb-0 text-danger">- {{ adjustmentForm.get('quantity')?.value }}</h4>
                </div>
              </div>
              <div class="col-md-4">
                <div class="summary-item">
                  <label class="text-muted small">New Stock</label>
                  <h4 class="mb-0" 
                      [class.text-warning]="getNewStock() <= 10"
                      [class.text-danger]="getNewStock() === 0">
                    {{ getNewStock() }}
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Approval Option -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="approvalRequired"
                formControlName="approvalRequired">
              <label class="form-check-label" for="approvalRequired">
                <strong>Require Approval</strong>
                <br>
                <small class="text-muted">
                  If checked, this adjustment will require admin approval before being applied to stock.
                </small>
              </label>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2 justify-content-end">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="cancel()"
            [disabled]="isSubmitting">
            Cancel
          </button>
          <button 
            type="submit" 
            class="btn btn-warning"
            [disabled]="isSubmitting || adjustmentForm.invalid">
            <i class="bi bi-save me-2"></i>
            Create Adjustment
          </button>
        </div>

      </form>
    </div>
  </div>
</div>
