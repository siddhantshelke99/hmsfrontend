<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Patient History</h2>
      <p class="text-muted mb-0">Complete medical record and visit history</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-success" (click)="exportPDF()">
        <i class="bi bi-file-pdf"></i> Export PDF
      </button>
      <button class="btn btn-outline-primary" (click)="printHistory()">
        <i class="bi bi-printer"></i> Print
      </button>
      <button class="btn btn-outline-secondary" routerLink="patients/registration">
        <i class="bi bi-arrow-left"></i> Back
      </button>
    </div>
  </div>

  <!-- Loader -->
  <app-loader *ngIf="isLoading"></app-loader>

  <!-- Content  && patientHistory-->
  <div *ngIf="!isLoading ">
    
    <!-- Patient Info Card -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-2 text-center">
            <img 
              [src]="patient?.photoUrl || 'assets/images/user/avatar-default.png'" 
              alt="Patient Photo"
              class="patient-photo img-thumbnail mb-2">
            <h5 class="mb-0">{{ patient?.name }}</h5>
            <p class="text-muted mb-0">{{ patient?.patientId }}</p>
          </div>
          <div class="col-md-10">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="text-muted small">Age / Gender</label>
                <p class="mb-0"><strong>{{ patient?.age }}Y / {{ patient?.gender }}</strong></p>
              </div>
              <div class="col-md-3">
                <label class="text-muted small">Blood Group</label>
                <p class="mb-0"><strong>{{ patient?.bloodGroup || 'N/A' }}</strong></p>
              </div>
              <div class="col-md-3">
                <label class="text-muted small">Mobile</label>
                <p class="mb-0"><strong>{{ patient?.mobileNumber }}</strong></p>
              </div>
              <div class="col-md-3">
                <label class="text-muted small">Email</label>
                <p class="mb-0"><strong>{{ patient?.email || 'N/A' }}</strong></p>
              </div>
              <div class="col-md-6">
                <label class="text-muted small">Address</label>
                <p class="mb-0"><strong>{{ patient?.address }}, {{ patient?.city }}, {{ patient?.state }} - {{ patient?.pincode }}</strong></p>
              </div>
              <div class="col-md-3">
                <label class="text-muted small">Emergency Contact</label>
                <p class="mb-0"><strong>{{ patient?.emergencyContactName }} ({{ patient?.emergencyContactRelation }})</strong></p>
                <p class="mb-0"><small>{{ patient?.emergencyContactNumber }}</small></p>
              </div>
              <div class="col-md-3">
                <label class="text-muted small">Registered On</label>
                <p class="mb-0"><strong>{{ patient?.createdAt | date: 'dd-MMM-yyyy' }}</strong></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a 
          class="nav-link" 
          [class.active]="activeTab === 'overview'"
          (click)="setActiveTab('overview')"
          href="javascript:void(0)">
          <i class="bi bi-info-circle me-2"></i>Overview
        </a>
      </li>
      <li class="nav-item">
        <a 
          class="nav-link" 
          [class.active]="activeTab === 'visits'"
          (click)="setActiveTab('visits')"
          href="javascript:void(0)">
          <i class="bi bi-calendar3 me-2"></i>Visits ({{ patientHistory?.visits?.length }})
        </a>
      </li>
      <li class="nav-item">
        <a 
          class="nav-link" 
          [class.active]="activeTab === 'vitals'"
          (click)="setActiveTab('vitals')"
          href="javascript:void(0)">
          <i class="bi bi-heart-pulse me-2"></i>Vital Signs ({{ patientHistory?.vitalSigns?.length }})
        </a>
      </li>
      <li class="nav-item">
        <a 
          class="nav-link" 
          [class.active]="activeTab === 'prescriptions'"
          (click)="setActiveTab('prescriptions')"
          href="javascript:void(0)">
          <i class="bi bi-file-medical me-2"></i>Prescriptions ({{ patientHistory?.prescriptions?.length }})
        </a>
      </li>
      <li class="nav-item">
        <a 
          class="nav-link" 
          [class.active]="activeTab === 'reports'"
          (click)="setActiveTab('reports')"
          href="javascript:void(0)">
          <i class="bi bi-file-earmark-text me-2"></i>Lab Reports ({{ patientHistory?.labReports?.length }})
        </a>
      </li>
    </ul>

    <!-- Tab Content -->
    
    <!-- Overview Tab -->
    <div *ngIf="activeTab === 'overview'">
      <div class="row">
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header bg-danger text-white">
              <h6 class="mb-0">Allergies</h6>
            </div>
            <div class="card-body">
              <ul class="list-unstyled mb-0" *ngIf="patientHistory?.allergies?.length > 0">
                <li *ngFor="let allergy of patientHistory?.allergies" class="mb-2">
                  <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                  {{ allergy }}
                </li>
              </ul>
              <p class="text-muted mb-0" *ngIf="patientHistory?.allergies?.length === 0">
                No known allergies
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
              <h6 class="mb-0">Chronic Conditions</h6>
            </div>
            <div class="card-body">
              <ul class="list-unstyled mb-0" *ngIf="patientHistory?.chronicConditions?.length > 0">
                <li *ngFor="let condition of patientHistory?.chronicConditions" class="mb-2">
                  <i class="bi bi-clipboard-pulse text-warning me-2"></i>
                  {{ condition }}
                </li>
              </ul>
              <p class="text-muted mb-0" *ngIf="patientHistory?.chronicConditions?.length === 0">
                No chronic conditions
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h6 class="mb-0">Current Medications</h6>
            </div>
            <div class="card-body">
              <ul class="list-unstyled mb-0" *ngIf="patientHistory?.currentMedications?.length > 0">
                <li *ngFor="let medication of patientHistory?.currentMedications" class="mb-2">
                  <i class="bi bi-capsule text-info me-2"></i>
                  {{ medication }}
                </li>
              </ul>
              <p class="text-muted mb-0" *ngIf="patientHistory?.currentMedications?.length === 0">
                No current medications
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Visits Tab -->
    <div *ngIf="activeTab === 'visits'">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Doctor</th>
                  <th>Department</th>
                  <th>Chief Complaint</th>
                  <th>Diagnosis</th>
                  <th>Status</th>
                  <th>Follow-up</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let visit of patientHistory.visits">
                  <td>{{ visit.visitDate | date: 'dd-MMM-yyyy HH:mm' }}</td>
                  <td>
                    <span class="badge" [ngClass]="getVisitTypeClass(visit.visitType)">
                      {{ visit.visitType }}
                    </span>
                  </td>
                  <td>{{ visit.doctorName }}</td>
                  <td>{{ visit.department }}</td>
                  <td>{{ visit.chiefComplaint }}</td>
                  <td>{{ visit.diagnosis || '-' }}</td>
                  <td>
                    <span class="badge" [ngClass]="getVisitStatusClass(visit.status)">
                      {{ visit.status }}
                    </span>
                  </td>
                  <td>{{ visit.followUpDate ? (visit.followUpDate | date: 'dd-MMM-yyyy') : '-' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="patientHistory.visits.length === 0" class="text-center py-4">
            <i class="bi bi-inbox display-4 text-muted"></i>
            <p class="text-muted mt-2">No visit records found</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Vital Signs Tab -->
    <div *ngIf="activeTab === 'vitals'">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>BP (Sys/Dia)</th>
                  <th>Pulse</th>
                  <th>Temp</th>
                  <th>RR</th>
                  <th>SpO2</th>
                  <th>Weight</th>
                  <th>Height</th>
                  <th>BMI</th>
                  <th>Recorded By</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let vital of patientHistory.vitalSigns">
                  <td>{{ vital.recordDate | date: 'dd-MMM-yyyy HH:mm' }}</td>
                  <td>
                    <span *ngIf="vital.bloodPressureSystolic && vital.bloodPressureDiastolic">
                      {{ vital.bloodPressureSystolic }}/{{ vital.bloodPressureDiastolic }} mmHg
                      <br>
                      <small class="text-muted">{{ getBPStatus(vital.bloodPressureSystolic, vital.bloodPressureDiastolic) }}</small>
                    </span>
                    <span *ngIf="!vital.bloodPressureSystolic">-</span>
                  </td>
                  <td>{{ vital.pulse || '-' }} <small *ngIf="vital.pulse">bpm</small></td>
                  <td>{{ vital.temperature || '-' }} <small *ngIf="vital.temperature">Â°F</small></td>
                  <td>{{ vital.respiratoryRate || '-' }} <small *ngIf="vital.respiratoryRate">/min</small></td>
                  <td>{{ vital.oxygenSaturation || '-' }} <small *ngIf="vital.oxygenSaturation">%</small></td>
                  <td>{{ vital.weight || '-' }} <small *ngIf="vital.weight">kg</small></td>
                  <td>{{ vital.height || '-' }} <small *ngIf="vital.height">cm</small></td>
                  <td>
                    <span *ngIf="vital.weight && vital.height">
                      {{ calculateBMI(vital.weight, vital.height) }}
                      <br>
                      <small class="text-muted">{{ getBMICategory(+calculateBMI(vital.weight, vital.height)) }}</small>
                    </span>
                    <span *ngIf="!vital.weight || !vital.height">-</span>
                  </td>
                  <td>{{ vital.recordedBy }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="patientHistory.vitalSigns.length === 0" class="text-center py-4">
            <i class="bi bi-inbox display-4 text-muted"></i>
            <p class="text-muted mt-2">No vital signs recorded</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Prescriptions Tab -->
    <div *ngIf="activeTab === 'prescriptions'">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="bi bi-file-medical display-1 text-muted"></i>
          <h5 class="mt-3">Prescriptions Module</h5>
          <p class="text-muted">Prescription history will be available once the Prescriptions module is implemented</p>
        </div>
      </div>
    </div>

    <!-- Lab Reports Tab -->
    <div *ngIf="activeTab === 'reports'">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="bi bi-file-earmark-text display-1 text-muted"></i>
          <h5 class="mt-3">Lab Reports Module</h5>
          <p class="text-muted">Lab reports will be available once the Lab Management module is implemented</p>
        </div>
      </div>
    </div>

  </div>
</div>
