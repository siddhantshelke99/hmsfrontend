<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Patient Registration</h2>
      <p class="text-muted mb-0">Register new patient for OPD/IPD services</p>
    </div>
    <button class="btn btn-outline-secondary" routerLink="/patients">
      <i class="bi bi-arrow-left"></i> Back to Patients
    </button>
  </div>

  <!-- Loader -->
  <app-loader *ngIf="isSubmitting"></app-loader>

  <!-- Registration Form -->
  <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()" *ngIf="!isSubmitting">
    <div class="row">
      <!-- Left Column -->
      <div class="col-lg-8">
        
        <!-- Personal Details -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Personal Details</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="firstName"
                  [class.is-invalid]="isFieldInvalid('firstName')"
                  placeholder="Enter first name">
                <div *ngIf="isFieldInvalid('firstName')" class="invalid-feedback">
                  First name is required (min 2 characters)
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Middle Name</label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="middleName"
                  placeholder="Enter middle name">
              </div>
              <div class="col-md-4">
                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="lastName"
                  [class.is-invalid]="isFieldInvalid('lastName')"
                  placeholder="Enter last name">
                <div *ngIf="isFieldInvalid('lastName')" class="invalid-feedback">
                  Last name is required
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                <input 
                  type="date" 
                  class="form-control" 
                  formControlName="dateOfBirth"
                  [class.is-invalid]="isFieldInvalid('dateOfBirth')"
                  [max]="maxDate">
                <div *ngIf="isFieldInvalid('dateOfBirth')" class="invalid-feedback">
                  Date of birth is required
                </div>
              </div>
              <div class="col-md-2">
                <label class="form-label">Age</label>
                <input 
                  type="number" 
                  class="form-control bg-light" 
                  formControlName="age"
                  readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label">Gender <span class="text-danger">*</span></label>
                <select 
                  class="form-select" 
                  formControlName="gender"
                  [class.is-invalid]="isFieldInvalid('gender')">
                  <option value="">-- Select --</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
                <div *ngIf="isFieldInvalid('gender')" class="invalid-feedback">
                  Gender is required
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Blood Group</label>
                <select class="form-select" formControlName="bloodGroup">
                  <option value="">-- Select --</option>
                  <option *ngFor="let bg of bloodGroups" [value]="bg">{{ bg }}</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Contact Details -->
        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">Contact Details</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Mobile Number <span class="text-danger">*</span></label>
                <input 
                  type="tel" 
                  class="form-control" 
                  formControlName="mobileNumber"
                  [class.is-invalid]="isFieldInvalid('mobileNumber')"
                  placeholder="10-digit mobile"
                  (blur)="checkDuplicate()">
                <div *ngIf="isFieldInvalid('mobileNumber')" class="invalid-feedback">
                  Valid 10-digit mobile number required
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Alternate Number</label>
                <input 
                  type="tel" 
                  class="form-control" 
                  formControlName="alternateNumber"
                  [class.is-invalid]="isFieldInvalid('alternateNumber')"
                  placeholder="10-digit mobile">
                <div *ngIf="isFieldInvalid('alternateNumber')" class="invalid-feedback">
                  Valid 10-digit mobile number required
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Email</label>
                <input 
                  type="email" 
                  class="form-control" 
                  formControlName="email"
                  [class.is-invalid]="isFieldInvalid('email')"
                  placeholder="email@example.com">
                <div *ngIf="isFieldInvalid('email')" class="invalid-feedback">
                  Valid email required
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Address -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">Address</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">Address <span class="text-danger">*</span></label>
                <textarea 
                  class="form-control" 
                  formControlName="address"
                  [class.is-invalid]="isFieldInvalid('address')"
                  rows="2"
                  placeholder="House/Flat No., Street, Locality"></textarea>
                <div *ngIf="isFieldInvalid('address')" class="invalid-feedback">
                  Address is required
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">City <span class="text-danger">*</span></label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="city"
                  [class.is-invalid]="isFieldInvalid('city')"
                  placeholder="Enter city">
                <div *ngIf="isFieldInvalid('city')" class="invalid-feedback">
                  City is required
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">State <span class="text-danger">*</span></label>
                <select 
                  class="form-select" 
                  formControlName="state"
                  [class.is-invalid]="isFieldInvalid('state')">
                  <option value="">-- Select State --</option>
                  <option *ngFor="let state of states" [value]="state">{{ state }}</option>
                </select>
                <div *ngIf="isFieldInvalid('state')" class="invalid-feedback">
                  State is required
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Pincode <span class="text-danger">*</span></label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="pincode"
                  [class.is-invalid]="isFieldInvalid('pincode')"
                  placeholder="6-digit pincode"
                  maxlength="6">
                <div *ngIf="isFieldInvalid('pincode')" class="invalid-feedback">
                  Valid 6-digit pincode required
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Emergency Contact -->
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Emergency Contact</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Contact Name <span class="text-danger">*</span></label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="emergencyContactName"
                  [class.is-invalid]="isFieldInvalid('emergencyContactName')"
                  placeholder="Full name">
                <div *ngIf="isFieldInvalid('emergencyContactName')" class="invalid-feedback">
                  Emergency contact name is required
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Contact Number <span class="text-danger">*</span></label>
                <input 
                  type="tel" 
                  class="form-control" 
                  formControlName="emergencyContactNumber"
                  [class.is-invalid]="isFieldInvalid('emergencyContactNumber')"
                  placeholder="10-digit mobile">
                <div *ngIf="isFieldInvalid('emergencyContactNumber')" class="invalid-feedback">
                  Valid emergency contact number required
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Relation <span class="text-danger">*</span></label>
                <select 
                  class="form-select" 
                  formControlName="emergencyContactRelation"
                  [class.is-invalid]="isFieldInvalid('emergencyContactRelation')">
                  <option value="">-- Select --</option>
                  <option value="Father">Father</option>
                  <option value="Mother">Mother</option>
                  <option value="Spouse">Spouse</option>
                  <option value="Son">Son</option>
                  <option value="Daughter">Daughter</option>
                  <option value="Brother">Brother</option>
                  <option value="Sister">Sister</option>
                  <option value="Friend">Friend</option>
                  <option value="Other">Other</option>
                </select>
                <div *ngIf="isFieldInvalid('emergencyContactRelation')" class="invalid-feedback">
                  Relation is required
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Medical Information -->
        <div class="card mb-4">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Medical Information (Optional)</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">Known Allergies</label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="allergies"
                  placeholder="Comma-separated (e.g., Penicillin, Peanuts)">
                <small class="text-muted">Separate multiple allergies with commas</small>
              </div>
              <div class="col-md-12">
                <label class="form-label">Chronic Conditions</label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="chronicConditions"
                  placeholder="Comma-separated (e.g., Diabetes, Hypertension)">
                <small class="text-muted">Separate multiple conditions with commas</small>
              </div>
              <div class="col-md-12">
                <label class="form-label">Current Medications</label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="currentMedications"
                  placeholder="Comma-separated">
                <small class="text-muted">Separate multiple medications with commas</small>
              </div>
              <div class="col-md-12">
                <label class="form-label">Remarks</label>
                <textarea 
                  class="form-control" 
                  formControlName="remarks"
                  rows="2"
                  placeholder="Additional notes"></textarea>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right Column -->
      <div class="col-lg-4">
        
        <!-- Photo Upload -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">Patient Photo</h6>
          </div>
          <div class="card-body text-center">
            <div class="photo-preview mb-3">
              <img 
                [src]="photoPreview || 'assets/images/user/avatar-default.png'" 
                alt="Patient Photo"
                class="img-thumbnail">
            </div>
            <input 
              type="file" 
              id="photoInput" 
              class="d-none" 
              accept="image/*"
              (change)="onPhotoSelected($event)">
            <label for="photoInput" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-camera me-2"></i>
              Choose Photo
            </label>
            <p class="text-muted small mt-2 mb-0">JPG/PNG, Max 2MB</p>
          </div>
        </div>

        <!-- Aadhar Verification -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">Aadhar Verification</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Aadhar Number <span class="text-danger">*</span></label>
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="aadharNumber"
                  [class.is-invalid]="isFieldInvalid('aadharNumber')"
                  placeholder="12-digit Aadhar"
                  maxlength="12"
                  (blur)="checkDuplicate()">
                <button 
                  type="button" 
                  class="btn btn-outline-primary"
                  (click)="verifyAadhar()"
                  [disabled]="!registrationForm.get('aadharNumber')?.valid">
                  <i class="bi bi-check-circle me-1"></i>
                  Verify
                </button>
              </div>
              <div *ngIf="isFieldInvalid('aadharNumber')" class="text-danger small mt-1">
                Valid 12-digit Aadhar number required
              </div>
              <div *ngIf="aadharVerified" class="text-success small mt-1">
                <i class="bi bi-check-circle-fill me-1"></i>
                Aadhar verified successfully
              </div>
            </div>
            <div>
              <label class="form-label">Upload Aadhar Copy</label>
              <input 
                type="file" 
                id="aadharFileInput" 
                class="form-control form-control-sm" 
                accept=".pdf,.jpg,.jpeg,.png"
                (change)="onAadharFileSelected($event)">
              <small class="text-muted">PDF/JPG/PNG, Max 5MB</small>
              <div *ngIf="selectedAadharFile" class="text-success small mt-1">
                <i class="bi bi-file-check me-1"></i>
                {{ selectedAadharFile.name }}
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="card">
          <div class="card-body">
            <button 
              type="submit" 
              class="btn btn-primary w-100 mb-2"
              [disabled]="isSubmitting || registrationForm.invalid || checkingDuplicate">
              <i class="bi bi-save me-2"></i>
              Register Patient
            </button>
            <button 
              type="button" 
              class="btn btn-outline-secondary w-100"
              (click)="clearForm()"
              [disabled]="isSubmitting">
              <i class="bi bi-arrow-repeat me-2"></i>
              Clear Form
            </button>
          </div>
        </div>

      </div>
    </div>
  </form>
</div>
