<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">OPD Token Generation</h2>
      <p class="text-muted mb-0">Generate consultation token for registered patients</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" routerLink="/patients/registration">
        <i class="bi bi-person-plus"></i> New Patient
      </button>
      <button class="btn btn-outline-primary" routerLink="/patients">
        <i class="bi bi-arrow-left"></i> Back
      </button>
    </div>
  </div>

  <div class="row">
    <!-- Token Form -->
    <div class="col-lg-8">
      <app-loader *ngIf="isSubmitting"></app-loader>

      <form [formGroup]="tokenForm" (ngSubmit)="onSubmit()" *ngIf="!isSubmitting">
        
        <!-- Patient Selection -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Patient Selection</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">Search Patient <span class="text-danger">*</span></label>
                <app-patient-search></app-patient-search>
                <input type="hidden" formControlName="patientId">
                <div *ngIf="isFieldInvalid('patientId')" class="text-danger small mt-1">
                  Please select a patient
                </div>
              </div>
              
              <!-- Selected Patient Info -->
              <div class="col-md-12" *ngIf="selectedPatient">
                <div class="alert alert-info mb-0">
                  <div class="row">
                    <div class="col-md-6">
                    <strong>Name:</strong> {{ selectedPatient.firstName }} {{ selectedPatient.lastName }}<br>
                    <strong>Patient ID:</strong> {{ selectedPatient.patientId }}<br>
                    <strong>Age/Gender:</strong> {{ selectedPatient.age }}Y / {{ selectedPatient.gender }}
                    </div>
                    <div class="col-md-6">
                      <strong>Mobile:</strong> {{ selectedPatient.mobileNumber }}<br>
                      <strong>Blood Group:</strong> {{ selectedPatient.bloodGroup || 'N/A' }}<br>
                      <strong>Registered:</strong> {{ selectedPatient.createdAt | date: 'dd-MMM-yyyy' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Doctor & Department Selection -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">Doctor & Department</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Department <span class="text-danger">*</span></label>
                <select 
                  class="form-select" 
                  formControlName="department"
                  [class.is-invalid]="isFieldInvalid('department')"
                  (change)="filterTokensByDepartment($any($event.target).value)">
                  <option value="">-- Select Department --</option>
                  <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
                </select>
                <div *ngIf="isFieldInvalid('department')" class="invalid-feedback">
                  Department is required
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Doctor <span class="text-danger">*</span></label>
                <select 
                  class="form-select" 
                  formControlName="doctorId"
                  [class.is-invalid]="isFieldInvalid('doctorId')">
                  <option value="">-- Select Doctor --</option>
                  <option *ngFor="let doctor of filteredDoctors" [value]="doctor.id">
                    {{ doctor.name }}
                  </option>
                </select>
                <div *ngIf="isFieldInvalid('doctorId')" class="invalid-feedback">
                  Doctor is required
                </div>
                <div *ngIf="selectedDoctorTokens > 0" class="text-info small mt-1">
                  <i class="bi bi-info-circle me-1"></i>
                  {{ selectedDoctorTokens }} token(s) in queue today
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Priority & Remarks -->
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Priority & Remarks</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Priority <span class="text-danger">*</span></label>
                <select 
                  class="form-select" 
                  formControlName="priority"
                  [class.is-invalid]="isFieldInvalid('priority')">
                  <option value="NORMAL">Normal</option>
                  <option value="URGENT">Urgent</option>
                  <option value="EMERGENCY">Emergency</option>
                </select>
                <small class="text-muted">Emergency cases will be prioritized</small>
              </div>
              <div class="col-md-12">
                <label class="form-label">Remarks</label>
                <textarea 
                  class="form-control" 
                  formControlName="remarks"
                  rows="2"
                  placeholder="Additional notes (chief complaint, etc.)"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 justify-content-end">
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="clearForm()"
            [disabled]="isSubmitting">
            Clear
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="isSubmitting || tokenForm.invalid">
            <i class="bi bi-ticket-perforated me-2"></i>
            Generate Token
          </button>
        </div>

      </form>
    </div>

    <!-- Today's Queue -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Today's Token Queue</h5>
        </div>
        <div class="card-body p-0">
          <app-loader *ngIf="isLoadingQueue"></app-loader>

          <div class="queue-list" *ngIf="!isLoadingQueue">
            <div 
              *ngFor="let token of filteredTokens" 
              class="queue-item"
              [class.priority-emergency]="token.priority === 'EMERGENCY'"
              [class.priority-urgent]="token.priority === 'URGENT'">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">
                    <span class="badge bg-dark me-2">{{ token.tokenNumber }}</span>
                    {{ token.patientName }}
                  </h6>
                  <small class="text-muted d-block">{{ token.doctorName }}</small>
                  <small class="text-muted d-block">{{ token.department }}</small>
                </div>
                <div class="text-end">
                  <span 
                    class="badge mb-1"
                    [ngClass]="getPriorityBadgeClass(token.priority)">
                    {{ token.priority }}
                  </span>
                  <br>
                  <span 
                    class="badge"
                    [ngClass]="getStatusBadgeClass(token.status)">
                    {{ token.status }}
                  </span>
                </div>
              </div>
              <div class="mt-2">
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i>
                  {{ token.checkInTime | date: 'HH:mm' }}
                  <span class="ms-2">Queue: {{ token.queuePosition }}</span>
                </small>
              </div>
            </div>

            <div *ngIf="filteredTokens.length === 0" class="text-center py-5">
              <i class="bi bi-inbox display-4 text-muted"></i>
              <p class="text-muted mt-2">No tokens generated today</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
