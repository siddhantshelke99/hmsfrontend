<div class="container-fluid py-4">
  <app-loader *ngIf="isLoading"></app-loader>

  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h2 class="mb-0">{{ getReportTitle() }}</h2>
      <p class="text-muted">Pharmacy performance and revenue analytics</p>
    </div>
    <div class="col-md-4 text-end">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" (click)="refreshReport()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button type="button" class="btn btn-outline-secondary" (click)="printReport()">
          <i class="bi bi-printer"></i> Print
        </button>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-download"></i> Export
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" (click)="exportReport(ReportFormat.PDF)">Export as PDF</a></li>
            <li><a class="dropdown-item" (click)="exportReport(ReportFormat.EXCEL)">Export as Excel</a></li>
            <li><a class="dropdown-item" (click)="exportReport(ReportFormat.CSV)">Export as CSV</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Type Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="currentReport === 'DISPENSING'" (click)="switchReport('DISPENSING')">
        <i class="bi bi-capsule"></i> Dispensing
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="currentReport === 'CONTROLLED_DRUGS'" (click)="switchReport('CONTROLLED_DRUGS')">
        <i class="bi bi-shield-check"></i> Controlled Drugs
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="currentReport === 'REVENUE'" (click)="switchReport('REVENUE')">
        <i class="bi bi-currency-rupee"></i> Revenue
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="currentReport === 'PERFORMANCE'" (click)="switchReport('PERFORMANCE')">
        <i class="bi bi-graph-up"></i> Performance
      </a>
    </li>
  </ul>

  <!-- Dispensing Report -->
  <div *ngIf="currentReport === 'DISPENSING' && pharmacyReport">
    <!-- Report Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form [formGroup]="reportForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" formControlName="startDate">
          </div>
          <div class="col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" formControlName="endDate">
          </div>
          <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-primary d-block" (click)="loadDispensingReport()">
              Generate Report
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Total Dispensing</h6>
                <h3 class="mb-0">{{ pharmacyReport.totalDispensing }}</h3>
                <small class="text-muted">
                  {{ pharmacyReport.startDate | date:'dd/MM/yyyy' }} - {{ pharmacyReport.endDate | date:'dd/MM/yyyy' }}
                </small>
              </div>
              <div class="stat-icon bg-primary">
                <i class="bi bi-capsule"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Total Amount</h6>
                <h3 class="mb-0">₹{{ pharmacyReport.totalAmount.toLocaleString() }}</h3>
                <small class="text-muted">Revenue generated</small>
              </div>
              <div class="stat-icon bg-success">
                <i class="bi bi-currency-rupee"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Pharmacists</h6>
                <h3 class="mb-0">{{ pharmacyReport.byPharmacist.length }}</h3>
                <small class="text-muted">Active staff</small>
              </div>
              <div class="stat-icon bg-info">
                <i class="bi bi-person-badge"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dispensing Table -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Dispensing Records</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Dispensing ID</th>
                <th>Prescription #</th>
                <th>Patient Name</th>
                <th>Dispensed Date</th>
                <th>Dispensed By</th>
                <th class="text-center">Items</th>
                <th class="text-end">Total Amount</th>
                <th>Payment Method</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of pharmacyReport.dispensingRecords">
                <td>
                  <strong>{{ item.dispensingId }}</strong>
                </td>
                <td>{{ item.prescriptionNumber }}</td>
                <td>{{ item.patientName }}</td>
                <td>{{ item.dispensedDate | date:'dd/MM/yyyy HH:mm' }}</td>
                <td>{{ item.dispensedBy }}</td>
                <td class="text-center">{{ item.itemCount }}</td>
                <td class="text-end">₹{{ item.totalAmount.toLocaleString() }}</td>
                <td>{{ item.paymentMethod }}</td>
                <td>
                  <span [class]="getPaymentStatusClass(item.paymentStatus)">
                    {{ item.paymentStatus }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Payment Method Distribution -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Payment Method Distribution</h5>
      </div>
      <div class="card-body">
        <div class="payment-chart">
          <div class="payment-item" *ngFor="let method of pharmacyReport.byPaymentMethod">
            <div class="payment-label">
              <strong>{{ method.method }}</strong>
              <span class="text-muted">{{ method.transactionCount }} transactions</span>
            </div>
            <div class="payment-bar-container">
              <div class="payment-bar" [style.width.%]="method.percentage"></div>
            </div>
            <div class="payment-value">
              ₹{{ method.totalAmount.toLocaleString() }}
              <span class="percentage">({{ method.percentage.toFixed(1) }}%)</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controlled Drug Report -->
  <div *ngIf="currentReport === 'CONTROLLED_DRUGS' && controlledDrugReport">
    <!-- Report Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form [formGroup]="reportForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" formControlName="startDate">
          </div>
          <div class="col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" formControlName="endDate">
          </div>
          <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-primary d-block" (click)="loadControlledDrugReport()">
              Generate Report
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Total Drugs</h6>
                <h3 class="mb-0">{{ controlledDrugReport.summary.totalDrugs }}</h3>
              </div>
              <div class="stat-icon bg-primary">
                <i class="bi bi-capsule-pill"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Total Dispensed</h6>
                <h3 class="mb-0">{{ controlledDrugReport.summary.totalDispensed }}</h3>
              </div>
              <div class="stat-icon bg-info">
                <i class="bi bi-box-arrow-right"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Prescriptions</h6>
                <h3 class="mb-0">{{ controlledDrugReport.summary.totalPrescriptions }}</h3>
              </div>
              <div class="stat-icon bg-success">
                <i class="bi bi-file-medical"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card" [class.border-danger]="controlledDrugReport.summary.discrepanciesFound > 0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Discrepancies</h6>
                <h3 class="mb-0" [class.text-danger]="controlledDrugReport.summary.discrepanciesFound > 0">
                  {{ controlledDrugReport.summary.discrepanciesFound }}
                </h3>
                <small class="text-muted">
                  Compliance: {{ controlledDrugReport.summary.complianceRate.toFixed(1) }}%
                </small>
              </div>
              <div class="stat-icon" [class.bg-danger]="controlledDrugReport.summary.discrepanciesFound > 0" [class.bg-success]="controlledDrugReport.summary.discrepanciesFound === 0">
                <i class="bi bi-shield-check"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alert if attention required -->
    <div class="alert alert-warning mb-4" *ngIf="controlledDrugReport.summary.requiresAttention">
      <i class="bi bi-exclamation-triangle"></i>
      <strong>Attention Required:</strong> Some controlled drugs have discrepancies that need immediate review and reconciliation.
    </div>

    <!-- Controlled Drug Table -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Controlled Drug Records</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Medicine Name</th>
                <th>Category</th>
                <th>License #</th>
                <th class="text-end">Opening</th>
                <th class="text-end">Receipts</th>
                <th class="text-end">Dispensed</th>
                <th class="text-end">Returned</th>
                <th class="text-end">Closing</th>
                <th class="text-end">Discrepancy</th>
                <th class="text-center">Prescriptions</th>
                <th class="text-center">Compliance</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let drug of controlledDrugReport.drugs; trackBy: trackByMedicineId" 
                  [class.table-danger]="!drug.compliance"
                  [class.table-warning]="drug.discrepancy !== 0">
                <td>
                  <strong>{{ drug.medicineName }}</strong>
                  <small class="d-block text-muted">{{ drug.medicineId }}</small>
                </td>
                <td>{{ drug.category }}</td>
                <td>{{ drug.licenseNumber }}</td>
                <td class="text-end">{{ drug.openingStock }}</td>
                <td class="text-end">{{ drug.receipts }}</td>
                <td class="text-end">{{ drug.dispensed }}</td>
                <td class="text-end">{{ drug.returned }}</td>
                <td class="text-end">{{ drug.closingStock }}</td>
                <td class="text-end" [class.text-danger]="drug.discrepancy !== 0" [class.fw-bold]="drug.discrepancy !== 0">
                  {{ drug.discrepancy }}
                </td>
                <td class="text-center">{{ drug.prescriptions }}</td>
                <td class="text-center">
                  <span [class]="getComplianceBadgeClass(drug.compliance)">
                    {{ drug.compliance ? 'Compliant' : 'Non-Compliant' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue Report -->
  <div *ngIf="currentReport === 'REVENUE' && revenueReport">
    <!-- Report Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form [formGroup]="reportForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" formControlName="startDate">
          </div>
          <div class="col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" formControlName="endDate">
          </div>
          <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-primary d-block" (click)="loadRevenueReport()">
              Generate Report
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Total Revenue</h6>
                <h3 class="mb-0">₹{{ revenueReport.totalRevenue.toLocaleString() }}</h3>
              </div>
              <div class="stat-icon bg-success">
                <i class="bi bi-currency-rupee"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Cash Revenue</h6>
                <h3 class="mb-0">₹{{ revenueReport.cashRevenue.toLocaleString() }}</h3>
              </div>
              <div class="stat-icon bg-primary">
                <i class="bi bi-cash-stack"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Digital Revenue</h6>
                <h3 class="mb-0">₹{{ revenueReport.digitalRevenue.toLocaleString() }}</h3>
              </div>
              <div class="stat-icon bg-info">
                <i class="bi bi-credit-card"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Free Dispensing</h6>
                <h3 class="mb-0">₹{{ revenueReport.freeDispensing.toLocaleString() }}</h3>
              </div>
              <div class="stat-icon bg-warning">
                <i class="bi bi-gift"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Revenue -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Revenue by Category</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Category</th>
                <th class="text-end">Revenue</th>
                <th class="text-center">Percentage</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cat of revenueReport.byCategory">
                <td><strong>{{ cat.category }}</strong></td>
                <td class="text-end">₹{{ cat.revenue.toLocaleString() }}</td>
                <td class="text-center">
                  <div class="progress" style="height: 25px;">
                    <div class="progress-bar bg-success" 
                         [style.width.%]="cat.percentage"
                         [attr.aria-valuenow]="cat.percentage">
                      {{ cat.percentage.toFixed(1) }}%
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Department Revenue -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Revenue by Department</h5>
      </div>
      <div class="card-body">
        <div class="revenue-chart">
          <div class="revenue-item" *ngFor="let dept of revenueReport.byDepartment">
            <div class="revenue-label">
              <strong>{{ dept.department }}</strong>
            </div>
            <div class="revenue-bar-container">
              <div class="revenue-bar" 
                   [style.width.%]="(dept.revenue / revenueReport.totalRevenue) * 100">
              </div>
            </div>
            <div class="revenue-value">
              ₹{{ dept.revenue.toLocaleString() }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Report (uses pharmacyReport data) -->
  <div *ngIf="currentReport === 'PERFORMANCE' && pharmacyReport">
    <!-- Report Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form [formGroup]="reportForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" formControlName="startDate">
          </div>
          <div class="col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" formControlName="endDate">
          </div>
          <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-primary d-block" (click)="loadPerformanceReport()">
              Generate Report
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Pharmacist Performance Table -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Pharmacist Performance</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Pharmacist</th>
                <th class="text-center">Total Dispensing</th>
                <th class="text-end">Total Amount</th>
                <th class="text-end">Avg per Dispensing</th>
                <th class="text-center">Avg Processing Time</th>
                <th class="text-center">Performance</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let pharmacist of pharmacyReport.byPharmacist; trackBy: trackByPharmacistId">
                <td>
                  <strong>{{ pharmacist.pharmacistName }}</strong>
                  <small class="d-block text-muted">{{ pharmacist.pharmacistId }}</small>
                </td>
                <td class="text-center">{{ pharmacist.totalDispensing }}</td>
                <td class="text-end">₹{{ pharmacist.totalAmount.toLocaleString() }}</td>
                <td class="text-end">₹{{ pharmacist.averagePerDispensing.toLocaleString() }}</td>
                <td class="text-center">{{ pharmacist.averageProcessingTime }} min</td>
                <td class="text-center">
                  <span class="badge" 
                        [class.bg-success]="pharmacist.averageProcessingTime < 10"
                        [class.bg-warning]="pharmacist.averageProcessingTime >= 10 && pharmacist.averageProcessingTime < 15"
                        [class.bg-danger]="pharmacist.averageProcessingTime >= 15">
                    {{ pharmacist.averageProcessingTime < 10 ? 'Excellent' : 
                       pharmacist.averageProcessingTime < 15 ? 'Good' : 'Needs Improvement' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
